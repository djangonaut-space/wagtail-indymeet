{% extends "base.html" %}
{% load static %}

{% block meta_title %}Django Contribution Opportunities{% endblock %}
{% block meta_description %}Discover ways to contribute to the Django ecosystem and grow your skills{% endblock %}

{% block extra_css %}
  <style>
      .autocomplete-dropdown {
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .card-hover-transform {
          transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .card-hover-transform:hover {
          transform: translateY(-2px);
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      /* Screen reader only styles */
      .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border: 0;
      }
  </style>
{% endblock %}

{% block content %}

    <div class="max-w-7xl mx-auto px-4 py-8" x-data="opportunitiesApp()">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">Django Contribution Opportunities</h1>
            <p class="text-lg text-gray-600">Discover ways to contribute to the Django ecosystem and grow your skills</p>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
            <div id="opportunity-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
                <!-- Name Search -->
                <div class="relative" x-data="autocomplete('name')">
                    <label for="name-search" class="block text-sm font-semibold text-gray-700 mb-2">Search by Name</label>
                    <input
                        type="text"
                        id="name-search"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-colors"
                        placeholder="Start typing..."
                        x-model="query"
                        @input="updateSuggestions"
                        @focus="showDropdown = true"
                        @blur="hideDropdown"
                        aria-describedby="name-search-desc"
                    >
                    <div id="name-search-desc" class="sr-only">Type to search opportunity names</div>
                    <div x-show="showDropdown && suggestions.length > 0"
                         class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg max-h-48 overflow-y-auto z-10 autocomplete-dropdown"
                         x-transition>
                        <template x-for="suggestion in suggestions" :key="suggestion">
                            <div class="px-4 py-3 cursor-pointer border-b border-gray-100 hover:bg-gray-50 last:border-b-0 suggestion-item"
                                 @mousedown.prevent="selectSuggestion(suggestion)"
                                 x-text="suggestion"></div>
                        </template>
                    </div>
                </div>

                <!-- Outcomes Search -->
                <div class="relative" x-data="autocomplete('outcomes')">
                    <label for="outcomes-search" class="block text-sm font-semibold text-gray-700 mb-2">Search by Outcomes</label>
                    <input
                        type="text"
                        id="outcomes-search"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-colors"
                        placeholder="e.g., technical knowledge"
                        x-model="query"
                        @input="updateSuggestions"
                        @focus="showDropdown = true"
                        @blur="hideDropdown"
                        aria-describedby="outcomes-search-desc"
                    >
                    <div id="outcomes-search-desc" class="sr-only">Type to search by outcomes</div>
                    <div x-show="showDropdown && suggestions.length > 0"
                         class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg max-h-48 overflow-y-auto z-10 autocomplete-dropdown"
                         x-transition>
                        <template x-for="suggestion in suggestions" :key="suggestion">
                            <div class="px-4 py-3 cursor-pointer border-b border-gray-100 hover:bg-gray-50 last:border-b-0 suggestion-item"
                                 @mousedown.prevent="selectSuggestion(suggestion)"
                                 x-text="suggestion"></div>
                        </template>
                    </div>
                </div>

                <!-- Requirements Search -->
                <div class="relative" x-data="autocomplete('requirements')">
                    <label for="requirements-search" class="block text-sm font-semibold text-gray-700 mb-2">Search by Requirements</label>
                    <input
                        type="text"
                        id="requirements-search"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-colors"
                        placeholder="e.g., Django experience"
                        x-model="query"
                        @input="updateSuggestions"
                        @focus="showDropdown = true"
                        @blur="hideDropdown"
                        aria-describedby="requirements-search-desc"
                    >
                    <div id="requirements-search-desc" class="sr-only">Type to search by requirements</div>
                    <div x-show="showDropdown && suggestions.length > 0"
                         class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg max-h-48 overflow-y-auto z-10 autocomplete-dropdown"
                         x-transition>
                        <template x-for="suggestion in suggestions" :key="suggestion">
                            <div class="px-4 py-3 cursor-pointer border-b border-gray-100 hover:bg-gray-50 last:border-b-0 suggestion-item"
                                 @mousedown.prevent="selectSuggestion(suggestion)"
                                 x-text="suggestion"></div>
                        </template>
                    </div>
                </div>

                <!-- Tags Search -->
                <div class="relative" x-data="autocomplete('tags')">
                    <label for="tags-search" class="block text-sm font-semibold text-gray-700 mb-2">Search by Tags</label>
                    <input
                        type="text"
                        id="tags-search"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-colors"
                        placeholder="e.g., mentorship, paid"
                        x-model="query"
                        @input="updateSuggestions"
                        @focus="showDropdown = true"
                        @blur="hideDropdown"
                        aria-describedby="tags-search-desc"
                    >
                    <div id="tags-search-desc" class="sr-only">Type to search by tags</div>
                    <div x-show="showDropdown && suggestions.length > 0"
                         class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-b-lg max-h-48 overflow-y-auto z-10 autocomplete-dropdown"
                         x-transition>
                        <template x-for="suggestion in suggestions" :key="suggestion">
                            <div class="px-4 py-3 cursor-pointer border-b border-gray-100 hover:bg-gray-50 last:border-b-0 suggestion-item"
                                 @mousedown.prevent="selectSuggestion(suggestion)"
                                 x-text="suggestion"></div>
                        </template>
                    </div>
                </div>

                <!-- Description Search -->
                <div>
                    <label for="description-search" class="block text-sm font-semibold text-gray-700 mb-2">Search Description</label>
                    <input
                        type="text"
                        id="description-search"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-colors"
                        placeholder="Search descriptions..."
                        x-model="filters.description"
                        aria-describedby="description-search-desc"
                    >
                    <div id="description-search-desc" class="sr-only">Type to search in descriptions</div>
                </div>
            </div>

            <!-- Type Filters -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">Filter by Type</label>
                <div class="flex flex-wrap gap-4">
                    <template x-for="type in availableTypes" :key="type">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input
                                type="checkbox"
                                :value="type"
                                x-model="filters.types"
                                class="w-5 h-5 text-purple-500 border-gray-300 rounded focus:ring-purple-400 focus:ring-2"
                                :aria-describedby="`type-${type}-desc`"
                            >
                            <span x-text="type" :id="`type-${type}-desc`" class="text-gray-700 capitalize"></span>
                        </label>
                    </template>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div>
                <button @click="clearAllFilters"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors">
                    Clear All Filters
                </button>
            </div>
        </div>

        <!-- Results Info -->
        <div class="text-center mb-8">
            <p class="text-gray-600" x-text="`Showing ${filteredOpportunities.length} of ${opportunities.length} opportunities`"></p>
        </div>

        <!-- No Results -->
        <div x-show="filteredOpportunities.length === 0" class="text-center py-12">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No opportunities found</h3>
            <p class="text-gray-600">Try adjusting your search criteria or clearing the filters.</p>
        </div>

        <!-- Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="opportunity in filteredOpportunities" :key="opportunity.name">
                <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer card-hover-transform"
                     @click="openModal(opportunity)"
                     role="button"
                     tabindex="0"
                     @keydown.enter="openModal(opportunity)"
                     @keydown.space.prevent="openModal(opportunity)"
                     :aria-label="`View details for ${opportunity.name}`">

                    <!-- Card Header -->
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-2" x-text="opportunity.name"></h3>
                        <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm font-medium capitalize"
                              x-text="opportunity.type"></span>
                    </div>

                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <template x-for="tag in opportunity.tags" :key="tag">
                            <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-medium" x-text="tag"></span>
                        </template>
                    </div>

                    <!-- Requirements Section -->
                    <div class="mb-4">
                        <div class="text-sm font-semibold text-gray-700 mb-2">Requirements</div>
                        <template x-if="opportunity.requirements !== null">
                            <div class="text-sm text-gray-600">
                                <span x-text="opportunity.requirements[0]"></span>
                                <span x-show="opportunity.requirements.length > 1"
                                      class="text-purple-500 font-medium"
                                      x-text="` and ${opportunity.requirements.length - 1} more`">
                                </span>
                            </div>
                        </template>
                        <template x-if="opportunity.requirements === null">
                          <div class="text-sm text-gray-600">Unknown</div>
                        </template>
                    </div>

                    <!-- Outcomes Section -->
                    <div class="mb-6">
                        <div class="text-sm font-semibold text-gray-700 mb-2">Outcomes</div>
                        <template x-if="opportunity.outcomes !== null">
                            <div class="text-sm text-gray-600">
                                <span x-text="opportunity.outcomes[0]"></span>
                                <span x-show="opportunity.outcomes.length > 1"
                                      class="text-purple-500 font-medium"
                                      x-text="` and ${opportunity.outcomes.length - 1} more`">
                                </span>
                            </div>
                        </template>
                        <template x-if="opportunity.outcomes === null">
                          <div class="text-sm text-gray-600">Unknown</div>
                        </template>
                    </div>

                    <!-- Learn More Link -->
                    <div x-show="opportunity.links && opportunity.links.length > 0">
                        <a :href="opportunity.links[0]"
                           class="inline-block bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                           @click.stop
                           target="_blank"
                           rel="noopener noreferrer">
                            Learn More
                        </a>
                    </div>
                </div>
            </template>
        </div>

        <!-- Modal -->
        <div x-show="showModal"
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
             @click.self="closeModal"
             x-transition.opacity>
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
                 role="dialog"
                 aria-modal="true"
                 :aria-labelledby="selectedOpportunity ? 'modal-title' : null">

                <!-- Modal Header -->
                <div class="flex justify-between items-start p-6 border-b border-gray-200">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800 flex-1 mr-4" x-text="selectedOpportunity?.name"></h2>
                    <button @click="closeModal"
                            class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 w-10 h-10 flex items-center justify-center text-xl"
                            aria-label="Close modal">
                        ×
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="p-6" x-show="selectedOpportunity">
                    <!-- Type and Tags -->
                    <div class="mb-6">
                        <div class="flex items-center gap-4 mb-4">
                            <span class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-medium capitalize"
                                  x-text="selectedOpportunity?.type"></span>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in selectedOpportunity?.tags || []" :key="tag">
                                <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-medium" x-text="tag"></span>
                            </template>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-6" x-show="selectedOpportunity?.description">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Description</h3>
                        <p class="text-gray-600 leading-relaxed" x-text="selectedOpportunity?.description"></p>
                    </div>

                    <!-- Requirements -->
                    <div class="mb-6" x-show="selectedOpportunity?.requirements?.length > 0">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Requirements</h3>
                        <ul class="space-y-2">
                            <template x-for="requirement in selectedOpportunity?.requirements || []" :key="requirement">
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                    <span class="text-gray-600" x-text="requirement"></span>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <!-- Outcomes -->
                    <div class="mb-6" x-show="selectedOpportunity?.outcomes?.length > 0">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Outcomes</h3>
                        <ul class="space-y-2">
                            <template x-for="outcome in selectedOpportunity?.outcomes || []" :key="outcome">
                                <li class="flex items-start">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                    <span class="text-gray-600" x-text="outcome"></span>
                                </li>
                            </template>
                        </ul>
                    </div>

                    <!-- Links -->
                    <div x-show="selectedOpportunity?.links?.length > 0">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Links</h3>
                        <ul class="space-y-2">
                            <template x-for="link in selectedOpportunity?.links || []" :key="link">
                                <li class="flex items-start">
                                  <span class="w-2 h-2 bg-purple-500 rounded-full mt-2 mr-3 flex-shrink-0"></span>
                                  <a :href="link"
                                   class="block text-purple-500 hover:text-purple-600 hover:underline break-all"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   x-text="link"></a>
                              </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section class="bg-purple-50 border border-purple-200 rounded-xl p-6 mt-12 text-center">
      <h2 class="text-xl font-semibold text-gray-800 mb-3">
          Want to add or edit opportunities?
      </h2>
      <p class="text-gray-600 mb-4">
          Edit the opportunities data and submit a Pull Request to contribute.
      </p>
      <a href="https://github.com/djangonaut-space/wagtail-indymeet/blob/develop/home/static/js/django_opportunties.js"
         target="_blank"
         rel="noopener noreferrer"
         class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
          </svg>
          Edit on GitHub
      </a>
  </section>

    <script src="{% static "js/django_opportunities.js" %}"></script>
    <script>
      // Main Alpine.js application
      function opportunitiesApp() {
          return {
              opportunities: django_contribution_opportunities,
              showModal: false,
              selectedOpportunity: null,
              filters: {
                  name: '',
                  outcomes: '',
                  requirements: '',
                  tags: '',
                  description: '',
                  types: []
              },

              init() {
                  // Initialize any setup needed
                  this.updateAvailableTypes();
              },

              get availableTypes() {
                  const types = new Set();
                  this.opportunities.forEach(opp => {
                      if (opp.type) {
                          types.add(opp.type);
                      }
                  });
                  return Array.from(types).sort();
              },

              sortOpportunities(opportunities) {
                if (
                    this.filters.name === ""
                    && this.filters.outcomes === ""
                    && this.filters.requirements === ""
                    && this.filters.tags === ""
                    && this.filters.description === ""
                    && this.filters.types.length === 0
                ) {
                  return opportunities
                }
                return opportunities.sort((a, b) => {
                    const nameA = a.name.toUpperCase(); // ignore upper and lowercase
                    const nameB = b.name.toUpperCase(); // ignore upper and lowercase
                    if (nameA < nameB) {
                      return -1;
                    }
                    if (nameA > nameB) {
                      return 1;
                    }
                    // names must be equal
                    return 0;
                })
              },

              get filteredOpportunities() {
                  const filtered = this.opportunities.filter(opportunity => {
                      // Name filter
                      if (this.filters.name && !opportunity.name.toLowerCase().includes(this.filters.name.toLowerCase())) {
                          return false;
                      }

                      // Description filter
                      if (this.filters.description && !opportunity.description.toLowerCase().includes(this.filters.description.toLowerCase())) {
                          return false;
                      }

                      // Outcomes filter
                      if (this.filters.outcomes && opportunity.outcomes !== null) {
                          const hasOutcome = opportunity.outcomes.some(outcome =>
                              outcome.toLowerCase().includes(this.filters.outcomes.toLowerCase())
                          );
                          if (!hasOutcome) return false;
                      }

                      // Requirements filter
                      if (this.filters.requirements && opportunity.requirements !== null) {
                          const hasRequirement = opportunity.requirements.some(requirement =>
                              requirement.toLowerCase().includes(this.filters.requirements.toLowerCase())
                          );
                          if (!hasRequirement) return false;
                      }

                      // Tags filter
                      if (this.filters.tags) {
                          const hasTag = opportunity.tags.some(tag =>
                              tag.toLowerCase().includes(this.filters.tags.toLowerCase())
                          );
                          if (!hasTag) return false;
                      }

                      // Type filter
                      if (this.filters.types.length > 0 && !this.filters.types.includes(opportunity.type)) {
                          return false;
                      }

                      return true;
                  });
                  return this.sortOpportunities(filtered);
              },

              openModal(opportunity) {
                  this.selectedOpportunity = opportunity;
                  this.showModal = true;
                  // Prevent body scroll when modal is open
                  document.body.style.overflow = 'hidden';

                  // Focus management for accessibility
                  this.$nextTick(() => {
                      const modal = document.querySelector('.modal');
                      if (modal) {
                          modal.focus();
                      }
                  });
              },

              closeModal() {
                  this.showModal = false;
                  this.selectedOpportunity = null;
                  // Restore body scroll
                  document.body.style.overflow = '';
              },

              clearAllFilters() {
                  this.filters = {
                      name: '',
                      outcomes: '',
                      requirements: '',
                      tags: '',
                      description: '',
                      types: []
                  };

                  // Also clear the autocomplete query values
                  // Find all autocomplete components and clear their queries
                  this.$nextTick(() => {
                      // Clear all input values directly
                      const inputs = document.querySelectorAll('#opportunity-filters input');
                      inputs.forEach(input => {
                          input.value = '';
                          // Trigger input event to update Alpine data
                          input.dispatchEvent(new Event('input', { bubbles: true }));
                      });
                  });
              },

              updateAvailableTypes() {
                  // This method can be called when opportunities data changes
                  this.$nextTick(() => {
                      // Force reactivity update if needed
                  });
              }
          };
      }

      // Autocomplete functionality
      function autocomplete(field) {
          return {
              query: '',
              showDropdown: false,
              suggestions: [],

              init() {
                  // Set up reactive watcher for query changes
                  this.$watch('query', (value) => {
                      this.updateParentFilter(value);
                  });
              },

              updateSuggestions() {
                  if (!this.query || this.query.length < 1) {
                      this.suggestions = [];
                      return;
                  }

                  const allValues = new Set();
                  const queryLower = this.query.toLowerCase();

                  // Get the parent component's opportunities
                  const opportunities = this.$store.opportunities || django_contribution_opportunities;

                  opportunities.forEach(opportunity => {
                      let values = [];

                      switch(field) {
                          case 'name':
                              values = [opportunity.name];
                              break;
                          case 'outcomes':
                              values = opportunity.outcomes || [];
                              break;
                          case 'requirements':
                              values = opportunity.requirements || [];
                              break;
                          case 'tags':
                              values = opportunity.tags || [];
                              break;
                      }

                      values.forEach(value => {
                          if (value && value.toLowerCase().includes(queryLower)) {
                              allValues.add(value);
                          }
                      });
                  });

                  this.suggestions = Array.from(allValues)
                      .sort()
                      .slice(0, 10); // Limit to 10 suggestions
              },

              selectSuggestion(suggestion) {
                  this.query = suggestion;
                  this.showDropdown = false;
                  this.updateParentFilter(suggestion);
              },

              hideDropdown() {
                  // Small delay to allow for click events on suggestions
                  setTimeout(() => {
                      this.showDropdown = false;
                  }, 150);
              },

              updateParentFilter(value) {
                  // Find the parent component and update the appropriate filter
                  const parentEl = this.$el.closest('[x-data*="opportunitiesApp"]');
                  if (parentEl && parentEl._x_dataStack) {
                      const parentData = parentEl._x_dataStack[0];
                      if (parentData && parentData.filters) {
                          parentData.filters[field] = value;
                      }
                  }
              }
          };
      }

      document.addEventListener('DOMContentLoaded', function() {
          // Improve focus management for cards
          document.addEventListener('click', function(e) {
              const card = e.target.closest('.opportunity-card');
              if (card && !e.target.closest('a')) {
                  // If clicking on a card but not on a link, focus the card
                  card.focus();
              }
          });
      });

    </script>
{% endblock %}
